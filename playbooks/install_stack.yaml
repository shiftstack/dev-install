---
- hosts: standalone
  become: true
  become_user: stack
  gather_facts: false
  vars_files: vars/defaults.yaml
  roles:
  - network_info

  tasks:

  - name: Get minimum ansible facts
    setup:
      gather_subset: min

  - name: Install the tripleo client
    yum:
      name:
      - ceph-ansible
      - python3-tripleoclient
    become: true
    become_user: root

  - name: Create dev-install_net_config.yaml
    template:
      mode: 0644
      src: dev-install_net_config.yaml.j2
      dest: "{{ ansible_env.HOME }}/dev-install_net_config.yaml"

  - name: Read dev-install_net_config.yaml
    slurp:
      src: "{{ ansible_env.HOME }}/dev-install_net_config.yaml"
    register: net_config

  - name: Create net_config_json fact
    set_fact:
      net_config_json: "{{ net_config['content'] | b64decode | from_yaml }}"

  - name: Set fact for SR-IOV services overrides
    set_fact:
      sriov_services_fact: "{{ sriov_interface|default(None)| ternary(sriov_services, []) }}"

  - name: Read the TripleO role
    slurp:
      src: "{{ standalone_role }}"
    register: role_yaml

  - name: Parse the role data
    set_fact:
      role_data: "{{ role_yaml['content'] | b64decode | from_yaml }}"

  - name: Set fact for the new role data
    set_fact:
      new_role_data: "{{ role_data }}"

  - name: Set the fact for overrides services
    set_fact:
      role_data: >
        {% set _ = new_role_data.0.__setitem__('ServicesDefault', new_role_data.0.ServicesDefault |
        union(sriov_services_fact) | union(standalone_role_overrides)) %}
        {{ new_role_data }}

  - name: Create the new role file
    copy:
      dest: "{{ ansible_env.HOME }}/tripleo_standalone_role.yaml"
      content: "{{ role_data }}"
      mode: 0644

  - name: Create standalone_parameters.yaml
    template:
      mode: 0644
      src: standalone_parameters.yaml.j2
      dest: "{{ ansible_env.HOME }}/standalone_parameters.yaml"

  # The Amphora image is broken for OSP17, see:
  # https://review.rdoproject.org/r/32023
  # Until then this is fine (tested) to use the latest
  # image from RDO:
  - name: Download the latest Amphora image for Octavia
    get_url:
      url: https://images.rdoproject.org/octavia/master/amphora-x64-haproxy-centos.qcow2
      dest: "{{ ansible_env.HOME }}/amphora.qcow2"

  - name: Create containers-prepare-parameters.yaml
    template:
      mode: 0644
      src: containers-prepare-parameters.yaml.j2
      dest: "{{ ansible_env.HOME }}/containers-prepare-parameters.yaml"

  - name: Generate a keypair for Octavia Amphora (needed by TripleO)
    shell: |
      if [ ! -f "{{ ansible_env.HOME }}/octavia" ]; then
          ssh-keygen -b 2048 -t rsa -f "{{ ansible_env.HOME }}/octavia" -q -N ""
      fi
    args:
      creates: "{{ ansible_env.HOME }}/octavia"

  - name: Create ceph_env fact
    set_fact:
      ceph_env:
        - /usr/share/openstack-tripleo-heat-templates/environments/ceph-ansible/ceph-ansible.yaml
    when: ceph_enabled

  - name: Install all tuned profiles if SR-IOV is enabled
    yum:
      name:
      - tuned-profiles-*
    become: true
    become_user: root
    when: dpdk_kernel_args is defined

  - name: Create sriov_env fact
    set_fact:
      sriov_env:
        - /usr/share/openstack-tripleo-heat-templates/environments/services/neutron-ovn-sriov.yaml
    when: sriov_interface is defined

  - name: Create default_tripleo_envs fact
    set_fact:
      default_tripleo_envs:
        - /usr/share/openstack-tripleo-heat-templates/environments/standalone/standalone-tripleo.yaml
        - "{{ ansible_env.HOME }}/containers-prepare-parameters.yaml"
        - "{{ ansible_env.HOME }}/standalone_parameters.yaml"

  - name: Run TripleO deploy
    import_role:
      name: tripleo.operator.tripleo_deploy
    vars:
      openstack_bin: sudo openstack
      tripleo_deploy_deployment_user: stack
      tripleo_deploy_standalone: true
      tripleo_deploy_output_dir: "{{ ansible_env.HOME }}"
      tripleo_deploy_local_ip: "{{ public_api }}"
      tripleo_deploy_control_virtual_ip: "{{ control_plane_ip }}"
      tripleo_deploy_environment_files: "{{ default_tripleo_envs | union(enabled_services) | union(ceph_env|default([])) | union(sriov_env|default([])) }}"
      tripleo_deploy_generate_scripts: true
      tripleo_deploy_keep_running: true
      tripleo_deploy_home_dir: "{{ ansible_env.HOME }}"
      tripleo_deploy_roles_file: "{{ ansible_env.HOME }}/tripleo_standalone_role.yaml"

  - name: Reboot if SR-IOV is enabled (to apply kernel changes)
    when:
      - sriov_interface is defined
    block:
      - name: Reboot the node
        become_user: root
        reboot:
      - name: Pause for 2 minutes to let all containers to start and OpenStack to be ready
        pause:
          minutes: 2
