---
- hosts: standalone
  become: true
  become_user: root
  gather_facts: false
  vars_files: vars/defaults.yaml
  roles:
  - network_info

  tasks:

  - name: Install ovs tools
    yum:
      state: installed
      name:
      - rhosp-openvswitch
      - NetworkManager-ovs
      - nmstate
      - iptables
    register: installovs

  - name: Restart NetworkManager to load ovs plugin # noqa 503
    systemd:
      name: "NetworkManager.service"
      enabled: true
      state: restarted
    when: installovs.changed

  - name: Start openvswitch
    systemd:
      name: openvswitch.service
      enabled: true
      state: started

  - name: Define dummy interfaces to be created
    set_fact:
      nmstate_ifs:
      - name: dummy0
        type: dummy
        state: up
        ipv4:
          enabled: false
        ipv6:
          enabled: false
      - name: dummy1
        type: dummy
        state: up
        ipv4:
          enabled: false
        ipv6:
          enabled: false

  - name: Construct a list of used SR-IOV interfaces
    set_fact:
      used_sriov_nics: "{{ sriov_interface is defined | ternary([sriov_interface], []) }}"

  - name: Construct a list of used nics
    set_fact:
      used_nics: "{{ [ network_info.public_ipv4.interface ] + used_sriov_nics }}"

  - name: Disable interfaces which aren't in use
    set_fact:
      nmstate_ifs: "{{ nmstate_ifs + [ {'name': item} | combine(removed) ] }}"
    loop: "{{ physical_nics | difference(sriov_vfs) | difference(used_nics) }}"
    vars:
      removed:
        state: absent

  - name: Disable DHCP on used SR-IOV PFs
    set_fact:
      nmstate_ifs: "{{ nmstate_ifs + [ {'name': item} | combine(nodhcp) ] }}"
    loop: "{{ used_sriov_nics }}"
    vars:
      nodhcp:
        ipv4:
          enabled: false
        ipv6:
          enabled: false

  - name: Log target nmstate
    debug:
      var: nmstate_ifs

  - name: Set nmstate # noqa 301
    command: nmstatectl set --no-commit --timeout 60
    args:
      stdin: "{{ network_state | to_nice_json }}"
    vars:
      network_state:
        interfaces: "{{ nmstate_ifs }}"
    register: nmstateset

  # Doing this in 2 steps means that we'll automatically rollback if we break
  # networking such that ansible can no longer connect
  - name: Commit the new network state # noqa 301
    command: nmstatectl commit "{{ checkpoint }}"
    vars:
      checkpoint: "{{ (nmstateset.stdout_lines|last).split()[1] }}"

  # This prevents OpenStack installation failure later if the network unit
  # failed because not all physical interfaces have DHCP
  - name: Ensure network systemd unit is up
    systemd:
      name: network
      state: started

  - name: Create systemd unit to add SNAT rule for hostonly network
    template:
      src: "standalone_snat.service.j2"
      dest: "/etc/systemd/system/standalone_hostonly_snat.service"
      owner: root
      group: root
      mode: '0644'
    vars:
      cidr: "{{ hostonly_cidr }}"
      exit_ip: "{{ network_info.public_ipv4.address }}"

  - name: Activate systemd units
    systemd:
      name: "{{ item }}.service"
      enabled: true
      state: started
      daemon_reload: true
    loop:
    - standalone_hostonly_snat
